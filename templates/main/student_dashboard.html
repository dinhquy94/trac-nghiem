{% extends "base.html" %}

{% block title %}Dashboard - Há»c sinh{% endblock %}

{% block content %}
<h1 style="color: white; margin-bottom: 2rem;">ğŸ‘¨â€ğŸ“ Dashboard Há»c sinh</h1>

<div class="grid grid-3">
    <div class="card">
        <h3 style="color: #667eea; margin-bottom: 1rem;">ğŸ“ Äá» thi kháº£ dá»¥ng</h3>
        <p style="font-size: 2rem; font-weight: bold; color: #333;">{{ exams|length }}</p>
        <a href="{{ url_for('exam.list_exams') }}" class="btn btn-primary btn-sm mt-2">Xem Ä‘á» thi</a>
    </div>
    
    <div class="card">
        <h3 style="color: #667eea; margin-bottom: 1rem;">âœ… BÃ i Ä‘Ã£ lÃ m</h3>
        <p style="font-size: 2rem; font-weight: bold; color: #333;">{{ attempts|length }}</p>
        <a href="{{ url_for('attempt.my_attempts') }}" class="btn btn-primary btn-sm mt-2">Xem káº¿t quáº£</a>
    </div>
    
    <div class="card">
        <h3 style="color: #667eea; margin-bottom: 1rem;">ğŸ† Äiá»ƒm trung bÃ¬nh</h3>
        {% set total = attempts|selectattr('status', 'equalto', 'graded')|list %}
        {% if total %}
            {% set avg = (total|sum(attribute='percentage') / total|length)|round(1) %}
            <p style="font-size: 2rem; font-weight: bold; color: #333;">{{ avg }}%</p>
        {% else %}
            <p style="font-size: 2rem; font-weight: bold; color: #999;">--</p>
        {% endif %}
    </div>
</div>

<div class="card mt-3">
    <h3 class="card-header">ğŸ“ Äá» thi kháº£ dá»¥ng</h3>
    {% if exams %}
    <div class="grid grid-2">
        {% for exam in exams %}
        <div style="padding: 1.5rem; border: 2px solid #e0e0e0; border-radius: 8px;">
            <h4 style="color: #333; margin-bottom: 0.5rem;">{{ exam.title }}</h4>
            <p style="color: #666; margin-bottom: 1rem;">{{ exam.description }}</p>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; font-size: 0.9rem; color: #666;">
                <span>â±ï¸ {{ exam.duration }} phÃºt</span>
                <span>ğŸ“„ {{ exam.question_count }} cÃ¢u</span>
                <span>ğŸ¯ Äiá»ƒm Ä‘áº¡t: {{ exam.passing_score }}%</span>
            </div>
            <a href="{{ url_for('attempt.start_exam', exam_id=exam._id) }}" class="btn btn-success btn-sm">LÃ m bÃ i</a>
            <a href="{{ url_for('exam.view_exam', exam_id=exam._id) }}" class="btn btn-secondary btn-sm">Xem chi tiáº¿t</a>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="color: #666; text-align: center; padding: 2rem;">ChÆ°a cÃ³ Ä‘á» thi nÃ o</p>
    {% endif %}
</div>

<div class="card mt-3">
    <h3 class="card-header">ğŸ† Báº£ng xáº¿p háº¡ng há»c sinh tÃ­ch cá»±c</h3>
    {% if top_students %}
    <table class="table">
        <thead>
            <tr>
                <th style="width: 60px; text-align: center;">Háº¡ng</th>
                <th>Há»c sinh</th>
                <th style="text-align: center;">Huy chÆ°Æ¡ng</th>
            </tr>
        </thead>
        <tbody>
            {% for student in top_students %}
            <tr style="{% if student._id|string == session.user_id %}background: #fff3cd; font-weight: bold;{% endif %}">
                <td style="text-align: center; font-size: 1.2rem;">
                    {% if loop.index == 1 %}
                        ğŸ¥‡
                    {% elif loop.index == 2 %}
                        ğŸ¥ˆ
                    {% elif loop.index == 3 %}
                        ğŸ¥‰
                    {% else %}
                        {{ loop.index }}
                    {% endif %}
                </td>
                <td>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <img src="{{ student.avatar_url|default_avatar(student.username) }}" alt="Avatar" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #667eea;" onerror="this.src='https://ui-avatars.com/api/?name={{ student.username }}&background=667eea&color=fff&size=128'">
                        <div>
                            <div style="font-weight: 600;">{{ student.full_name or student.username }}</div>
                            <div style="font-size: 0.85rem; color: #666;">@{{ student.username }}</div>
                        </div>
                    </div>
                </td>
                <td style="text-align: center;">
                    <span style="background: linear-gradient(135deg, #ffd700, #ffed4e); padding: 0.4rem 0.8rem; border-radius: 15px; font-weight: bold; font-size: 1.1rem;">
                        ğŸ† {{ student.medals or 0 }}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #666; text-align: center; padding: 2rem;">ChÆ°a cÃ³ dá»¯ liá»‡u xáº¿p háº¡ng</p>
    {% endif %}
</div>

<div class="card mt-3">
    <h3 class="card-header">âœ… BÃ i lÃ m gáº§n Ä‘Ã¢y</h3>
    {% if attempts %}
    <table class="table">
        <thead>
            <tr>
                <th>Äá» thi</th>
                <th>NgÃ y lÃ m</th>
                <th>Äiá»ƒm</th>
                <th>Tráº¡ng thÃ¡i</th>
                <th>Thao tÃ¡c</th>
            </tr>
        </thead>
        <tbody>
            {% for attempt in attempts[:10] %}
            <tr>
                <td>Äá» thi #{{ attempt.exam_id }}</td>
                <td>{{ attempt.created_at|datetime }}</td>
                <td>
                    {% if attempt.status == 'graded' %}
                        {{ attempt.score }}/{{ attempt.max_score }} ({{ attempt.percentage }}%)
                    {% else %}
                        --
                    {% endif %}
                </td>
                <td>
                    {% if attempt.status == 'graded' %}
                        {% if attempt.passed %}
                            <span class="badge badge-success">Äáº¡t</span>
                        {% else %}
                            <span class="badge badge-danger">KhÃ´ng Ä‘áº¡t</span>
                        {% endif %}
                    {% elif attempt.status == 'submitted' %}
                        <span class="badge badge-warning">Äang cháº¥m</span>
                    {% else %}
                        <span class="badge badge-info">Äang lÃ m</span>
                    {% endif %}
                </td>
                <td>
                    {% if attempt.status == 'graded' %}
                        <a href="{{ url_for('attempt.view_result', attempt_id=attempt._id) }}" class="btn btn-sm btn-primary">Xem káº¿t quáº£</a>
                    {% elif attempt.status == 'in_progress' %}
                        <a href="{{ url_for('attempt.take_exam', attempt_id=attempt._id) }}" class="btn btn-sm btn-success">Tiáº¿p tá»¥c</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #666; text-align: center; padding: 2rem;">Báº¡n chÆ°a lÃ m bÃ i thi nÃ o</p>
    {% endif %}
</div>
{% endblock %}
