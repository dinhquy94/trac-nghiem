{% extends "base.html" %}

{% block title %}L√†m b√†i thi - {{ exam.title }}{% endblock %}

{% block extra_css %}
<style>
.exam-container {
    max-width: 900px;
    margin: 0 auto;
}
.timer {
    position: fixed;
    top: 100px;
    right: 20px;
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 100;
}
.timer-value {
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
}
.question-card {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.option-label {
    display: block;
    padding: 1rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: all 0.3s;
}
.option-label:hover {
    border-color: #667eea;
    background: #f8f9fa;
}
.option-label input:checked + span {
    color: #667eea;
    font-weight: bold;
}
</style>
{% endblock %}

{% block content %}
{% if exam.exam_type == 'test' and exam.duration > 0 %}
<div class="timer">
    <div style="text-align: center;">
        <div style="color: #666; margin-bottom: 0.5rem;">‚è±Ô∏è Th·ªùi gian c√≤n l·∫°i</div>
        <div class="timer-value" id="timer">{{ exam.duration }}:00</div>
    </div>
</div>
{% endif %}

<div class="exam-container">
    <div class="card">
        <h2 class="card-header text-center">
            üìù {{ exam.title }}
            {% if exam.exam_type == 'practice' %}
            <span class="badge badge-info" style="font-size: 0.6em;">√în t·∫≠p</span>
            {% endif %}
        </h2>
        <div style="text-align: center; color: #666; margin-bottom: 2rem;">
            {{ questions|length }} c√¢u h·ªèi | {{ exam.total_points }} ƒëi·ªÉm
            {% if exam.exam_type == 'practice' %}
            <br><small style="color: #28a745;">ƒê·ªÅ √¥n t·∫≠p - Kh√¥ng gi·ªõi h·∫°n th·ªùi gian</small>
            {% endif %}
        </div>
    </div>
    
    <form id="examForm" method="POST" action="{{ url_for('attempt.submit_exam', attempt_id=attempt._id) }}">
        {% for question in questions %}
        <div class="question-card">
            <h3 style="color: #333; margin-bottom: 1rem;">
                C√¢u {{ loop.index }}: {{ question.question_text }}
                <span class="badge badge-info">{{ question.points }} ƒëi·ªÉm</span>
            </h3>
            
            {% if question.question_type == 'multiple_choice' %}
                {% for option in question.options %}
                <label class="option-label">
                    <input type="radio" name="question_{{ question._id }}" value="{{ option[0] }}" style="display: none;" required>
                    <span>{{ option }}</span>
                </label>
                {% endfor %}
            {% elif question.question_type == 'true_false' %}
                <label class="option-label">
                    <input type="radio" name="question_{{ question._id }}" value="ƒê√∫ng" style="display: none;" required>
                    <span>A. ƒê√∫ng</span>
                </label>
                <label class="option-label">
                    <input type="radio" name="question_{{ question._id }}" value="Sai" style="display: none;" required>
                    <span>B. Sai</span>
                </label>
            {% elif question.question_type == 'listening' %}
                <div style="margin-bottom: 1.5rem;">
                    {% if question.media_url %}
                    <div style="margin-bottom: 1rem;">
                        <p style="color: #667eea; font-weight: bold;">üéµ Nghe audio</p>
                        <audio controls style="width: 100%; margin-bottom: 1rem;">
                            <source src="{{ question.media_url }}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                    {% endif %}
                    {% if question.support_content %}
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <p style="color: #666; margin-bottom: 0.5rem;"><strong>üìÑ H·ªó tr·ª£:</strong></p>
                        <p>{{ question.support_content }}</p>
                    </div>
                    {% endif %}
                </div>
                <textarea name="question_{{ question._id }}" class="form-control" rows="4" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n..." required></textarea>
            {% elif question.question_type == 'speaking' %}
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: #667eea; font-weight: bold;">üé§ Luy·ªán n√≥i</p>
                    {% if question.support_content %}
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <p style="color: #666; margin-bottom: 0.5rem;"><strong>ƒê·ªÅ b√†i:</strong></p>
                        <p>{{ question.support_content }}</p>
                    </div>
                    {% endif %}
                    <div style="background: #fff3cd; padding: 1rem; border-radius: 8px;">
                        <p style="margin: 0;"><small><strong>‚ö†Ô∏è L∆∞u √Ω:</strong> Vui l√≤ng ghi √¢m c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n ho·∫∑c m√¥ t·∫£ n√≥ chi ti·∫øt trong √¥ b√™n d∆∞·ªõi.</small></p>
                    </div>
                </div>
                <textarea name="question_{{ question._id }}" class="form-control" rows="4" placeholder="M√¥ t·∫£ c√¢u tr·∫£ l·ªùi ho·∫∑c ghi ch√∫ v·ªÅ b√†i n√≥i c·ªßa b·∫°n..." required></textarea>
            {% elif question.question_type == 'reading' %}
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: #667eea; font-weight: bold;">üìñ ƒê·ªçc hi·ªÉu</p>
                    {% if question.media_url %}
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <p style="color: #666; margin-bottom: 0.5rem;"><strong>üìÑ ƒêo·∫°n vƒÉn:</strong></p>
                        <p>{{ question.media_url }}</p>
                    </div>
                    {% endif %}
                </div>
                <textarea name="question_{{ question._id }}" class="form-control" rows="4" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n..." required></textarea>
            {% elif question.question_type == 'writing' %}
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: #667eea; font-weight: bold;">‚úçÔ∏è Vi·∫øt</p>
                    {% if question.support_content %}
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <p style="color: #666; margin-bottom: 0.5rem;"><strong>H∆∞·ªõng d·∫´n:</strong></p>
                        <p>{{ question.support_content }}</p>
                    </div>
                    {% endif %}
                </div>
                <textarea name="question_{{ question._id }}" class="form-control" rows="6" placeholder="Vi·∫øt b√†i c·ªßa b·∫°n t·∫°i ƒë√¢y..." required></textarea>
            {% elif question.question_type == 'group' %}
                <div style="background: #f0f4ff; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <p style="color: #667eea; font-weight: bold; margin-bottom: 1rem;">üìö Nh√≥m c√¢u h·ªèi</p>
                    <p style="color: #333; margin: 0;">{{ question.group_prompt }}</p>
                </div>
                {% if question.media_url %}
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: #667eea; font-weight: bold;">üéµ Media cho nh√≥m c√¢u h·ªèi</p>
                    {% if question.media_url.lower().endswith(('.mp3', '.wav', '.m4a', '.flac', '.ogg')) %}
                    <audio controls style="width: 100%; margin-bottom: 1rem;">
                        <source src="{{ question.media_url }}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                    {% else %}
                    <video controls style="width: 100%; max-height: 400px; margin-bottom: 1rem;">
                        <source src="{{ question.media_url }}" type="video/mp4">
                        Your browser does not support the video element.
                    </video>
                    {% endif %}
                </div>
                {% endif %}
                <textarea name="question_{{ question._id }}" class="form-control" rows="5" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n..." required></textarea>
            {% elif question.question_type == 'essay' %}
                <textarea name="question_{{ question._id }}" class="form-control" rows="5" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n..." required></textarea>
            {% endif %}
        </div>
        {% endfor %}
        
        <div class="card text-center">
            <button type="submit" class="btn btn-success" style="font-size: 1.2rem; padding: 1rem 3rem;">
                ‚úÖ N·ªôp b√†i
            </button>
        </div>
    </form>
</div>

<script>
{% if exam.exam_type == 'test' and exam.duration > 0 %}
// Timer countdown
let duration = {{ exam.duration }} * 60; // Convert to seconds
const timerElement = document.getElementById('timer');

function updateTimer() {
    const minutes = Math.floor(duration / 60);
    const seconds = duration % 60;
    timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (duration <= 0) {
        alert('H·∫øt gi·ªù! B√†i thi s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông n·ªôp.');
        document.getElementById('examForm').submit();
        return;
    }
    
    // Change color when time is running out
    if (duration <= 300) { // 5 minutes
        timerElement.style.color = '#dc3545';
    } else if (duration <= 600) { // 10 minutes
        timerElement.style.color = '#ffc107';
    }
    
    duration--;
    setTimeout(updateTimer, 1000);
}

updateTimer();
{% endif %}

// Add click handler to option labels
document.querySelectorAll('.option-label').forEach(label => {
    label.addEventListener('click', function() {
        const input = this.querySelector('input');
        if (input.type === 'radio') {
            // Uncheck all other options in the same group
            const name = input.name;
            document.querySelectorAll(`input[name="${name}"]`).forEach(radio => {
                radio.closest('.option-label').style.borderColor = '#e0e0e0';
                radio.closest('.option-label').style.background = 'white';
            });
            // Check this option
            input.checked = true;
            this.style.borderColor = '#667eea';
            this.style.background = '#f0f4ff';
        }
    });
});

// Warn before leaving page
window.addEventListener('beforeunload', function(e) {
    e.preventDefault();
    e.returnValue = '';
});

// Form submit handler with validation
document.getElementById('examForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Ki·ªÉm tra t·∫•t c·∫£ c√°c c√¢u h·ªèi ƒë√£ ƒë∆∞·ª£c tr·∫£ l·ªùi
    const questions = document.querySelectorAll('.question-card');
    let unansweredCount = 0;
    let unansweredQuestions = [];
    
    questions.forEach((questionCard, index) => {
        const questionNumber = index + 1;
        
        // Ki·ªÉm tra radio/checkbox
        const radios = questionCard.querySelectorAll('input[type="radio"]');
        if (radios.length > 0) {
            const checked = Array.from(radios).some(r => r.checked);
            if (!checked) {
                unansweredCount++;
                unansweredQuestions.push(questionNumber);
            }
        }
        
        // Ki·ªÉm tra textarea
        const textarea = questionCard.querySelector('textarea');
        if (textarea && !textarea.value.trim()) {
            unansweredCount++;
            unansweredQuestions.push(questionNumber);
        }
    });
    
    if (unansweredCount > 0) {
        const questionList = unansweredQuestions.join(', ');
        alert(`Vui l√≤ng tr·∫£ l·ªùi h·∫øt t·∫•t c·∫£ c√°c c√¢u h·ªèi.\n\nC√¢u ch∆∞a tr·∫£ l·ªùi: ${questionList}`);
        return false;
    }
    
    // N·∫øu t·∫•t c·∫£ c√¢u h·ªèi ƒë√£ tr·∫£ l·ªùi, y√™u c·∫ßu x√°c nh·∫≠n
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i?\n\nL∆∞u √Ω: Kh√¥ng th·ªÉ ch·ªânh s·ª≠a sau khi n·ªôp!')) {
        const formData = new FormData(this);
        
        fetch(this.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.removeEventListener('beforeunload', arguments.callee);
                window.location.href = data.redirect;
            } else {
                alert('C√≥ l·ªói x·∫£y ra: ' + data.message);
            }
        })
        .catch(error => {
            alert('C√≥ l·ªói x·∫£y ra khi n·ªôp b√†i');
            console.error(error);
        });
    }
    
    return false;
});
</script>
{% endblock %}
