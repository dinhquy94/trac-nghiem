{% extends "base.html" %}

{% block title %}K·∫øt qu·∫£ thi - {{ exam.title }}{% endblock %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto;">
    <h1 style="color: white; text-align: center; margin-bottom: 2rem;">
        {% if attempt.passed %}üéâ{% else %}üìä{% endif %} K·∫øt qu·∫£ thi
    </h1>
    
    <div class="card text-center">
        <h2 style="color: #333; margin-bottom: 1rem;">{{ exam.title }}</h2>
        
        <div style="background: {% if attempt.passed %}#d4edda{% else %}#f8d7da{% endif %}; padding: 2rem; border-radius: 12px; margin: 2rem 0;">
            <div style="font-size: 3rem; font-weight: bold; color: {% if attempt.passed %}#155724{% else %}#721c24{% endif %}; margin-bottom: 0.5rem;">
                {{ attempt.percentage }}%
            </div>
            <div style="font-size: 1.2rem; color: {% if attempt.passed %}#155724{% else %}#721c24{% endif %};">
                {{ attempt.score }}/{{ attempt.max_score }} ƒëi·ªÉm
            </div>
            <div style="font-size: 1.5rem; font-weight: bold; margin-top: 1rem;">
                {% if attempt.passed %}
                    <span style="color: #28a745;">‚úÖ ƒê·∫†T</span>
                {% else %}
                    <span style="color: #dc3545;">‚ùå KH√îNG ƒê·∫†T</span>
                {% endif %}
            </div>
        </div>
        
        <div class="grid grid-3" style="text-align: left;">
            <div>
                <strong>Th·ªùi gian l√†m b√†i:</strong>
                <p>{{ (attempt.submitted_at - attempt.started_at).total_seconds() // 60 }} ph√∫t</p>
            </div>
            <div>
                <strong>ƒêi·ªÉm ƒë·∫°t y√™u c·∫ßu:</strong>
                <p>{{ exam.passing_score }}%</p>
            </div>
            <div>
                <strong>S·ªë c√¢u ƒë√∫ng:</strong>
                {% if attempt.max_score > 0 %}
                <p>{{ (attempt.score / attempt.max_score * questions|length)|round|int }} / {{ questions|length }}</p>
                {% else %}
                <p>0 / 0 (kh√¥ng c√≥ c√¢u h·ªèi)</p>
                {% endif %}
            </div>
        </div>
        
        {% if student %}
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0;">
            <strong>H·ªçc sinh:</strong> {{ student.username }}
        </div>
        {% endif %}
    </div>
    
    <div class="card mt-3">
        <h3 class="card-header">üìù Chi ti·∫øt b√†i l√†m</h3>
        
        {% if questions|length > 0 %}
        {% for question in questions %}
        <div style="padding: 1.5rem; border-bottom: 1px solid #e0e0e0;">
            <div class="d-flex justify-between align-center mb-2">
                <strong style="color: #333;">C√¢u {{ loop.index }}: {{ question.question_text }}</strong>
                <div class="d-flex gap-1">
                    <span class="badge badge-info">{{ question.points }} ƒëi·ªÉm</span>
                    {% set student_answer = attempt.answers.get(question._id|string, '') %}
                    {% set is_correct = student_answer.strip().upper() == question.correct_answer.strip().upper() %}
                    {% if question.question_type in ['multiple_choice', 'true_false'] %}
                        {% if is_correct %}
                            <span class="badge badge-success">‚úì ƒê√∫ng</span>
                        {% else %}
                            <span class="badge badge-danger">‚úó Sai</span>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            
            {% if question.question_type == 'multiple_choice' %}
            <div style="margin-left: 1rem; margin-top: 1rem;">
                {% for option in question.options %}
                {% set is_student_choice = option.startswith(student_answer) %}
                {% set is_correct_option = option.startswith(question.correct_answer) %}
                <div style="padding: 0.5rem; margin: 0.25rem 0; border-radius: 4px; 
                    background: {% if is_correct_option %}#d4edda{% elif is_student_choice %}#f8d7da{% else %}white{% endif %};
                    border: 2px solid {% if is_correct_option %}#28a745{% elif is_student_choice %}#dc3545{% else %}#e0e0e0{% endif %};">
                    {{ option }}
                    {% if is_correct_option %}<strong style="color: #28a745;"> ‚Üê ƒê√°p √°n ƒë√∫ng</strong>{% endif %}
                    {% if is_student_choice and not is_correct_option %}<strong style="color: #dc3545;"> ‚Üê B·∫°n ch·ªçn</strong>{% endif %}
                </div>
                {% endfor %}
            </div>
            {% if exam.exam_type == 'practice' and question.explanation %}
            <div class="alert alert-info mt-2" style="background: #e7f3ff; border-left: 4px solid #2196f3; padding: 1rem; margin-left: 1rem; margin-top: 1rem;">
                <strong>üí° Gi·∫£i th√≠ch:</strong> {{ question.explanation }}
            </div>
            {% endif %}
            {% elif question.question_type == 'true_false' %}
            <div style="margin-left: 1rem; margin-top: 1rem;">
                <div style="padding: 0.5rem; margin: 0.25rem 0; border-radius: 4px; 
                    background: {% if question.correct_answer == 'ƒê√∫ng' %}#d4edda{% elif student_answer == 'ƒê√∫ng' %}#f8d7da{% else %}white{% endif %};
                    border: 2px solid {% if question.correct_answer == 'ƒê√∫ng' %}#28a745{% elif student_answer == 'ƒê√∫ng' %}#dc3545{% else %}#e0e0e0{% endif %};">
                    A. ƒê√∫ng
                    {% if question.correct_answer == 'ƒê√∫ng' %}<strong style="color: #28a745;"> ‚Üê ƒê√°p √°n ƒë√∫ng</strong>{% endif %}
                    {% if student_answer == 'ƒê√∫ng' and question.correct_answer != 'ƒê√∫ng' %}<strong style="color: #dc3545;"> ‚Üê B·∫°n ch·ªçn</strong>{% endif %}
                </div>
                <div style="padding: 0.5rem; margin: 0.25rem 0; border-radius: 4px; 
                    background: {% if question.correct_answer == 'Sai' %}#d4edda{% elif student_answer == 'Sai' %}#f8d7da{% else %}white{% endif %};
                    border: 2px solid {% if question.correct_answer == 'Sai' %}#28a745{% elif student_answer == 'Sai' %}#dc3545{% else %}#e0e0e0{% endif %};">
                    B. Sai
                    {% if question.correct_answer == 'Sai' %}<strong style="color: #28a745;"> ‚Üê ƒê√°p √°n ƒë√∫ng</strong>{% endif %}
                    {% if student_answer == 'Sai' and question.correct_answer != 'Sai' %}<strong style="color: #dc3545;"> ‚Üê B·∫°n ch·ªçn</strong>{% endif %}
                </div>
            </div>
            {% if exam.exam_type == 'practice' and question.explanation %}
            <div class="alert alert-info mt-2" style="background: #e7f3ff; border-left: 4px solid #2196f3; padding: 1rem; margin-left: 1rem; margin-top: 1rem;">
                <strong>üí° Gi·∫£i th√≠ch:</strong> {{ question.explanation }}
            </div>
            {% endif %}
            {% elif question.question_type == 'essay' %}
            <div style="margin-top: 1rem;">
                <strong>C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</strong>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
                    {{ student_answer }}
                </div>
                {% if question.correct_answer %}
                <div style="margin-top: 1rem;">
                    <strong>G·ª£i √Ω ƒë√°p √°n:</strong>
                    <div style="background: #d4edda; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
                        {{ question.correct_answer }}
                    </div>
                </div>
                {% endif %}
            </div>
            {% elif question.question_type == 'listening' %}
            <div style="margin-top: 1rem;">
                {% if question.media_url %}
                <div style="margin-bottom: 1rem;">
                    <p style="color: #667eea; font-weight: bold;">üéµ Audio g·ªëc</p>
                    <audio controls style="width: 100%;">
                        <source src="{{ question.media_url }}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                </div>
                {% endif %}
                <strong>C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</strong>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
                    {{ student_answer }}
                </div>
                {% if question.correct_answer %}
                <div style="margin-top: 1rem;">
                    <strong>G·ª£i √Ω ƒë√°p √°n:</strong>
                    <div style="background: #d4edda; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
                        {{ question.correct_answer }}
                    </div>
                </div>
                {% endif %}
            </div>
            {% elif question.question_type == 'speaking' %}
            <div style="margin-top: 1rem;">
                <strong>B√†i n√≥i c·ªßa b·∫°n:</strong>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
                    {{ student_answer }}
                </div>
                {% if question.support_content %}
                <div style="margin-top: 1rem;">
                    <strong>ƒê·ªÅ b√†i:</strong>
                    <div style="background: #e7f3ff; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
                        {{ question.support_content }}
                    </div>
                </div>
                {% endif %}
                {% if question.correct_answer %}
                <div style="margin-top: 1rem;">
                    <strong>G·ª£i √Ω ƒë√°p √°n:</strong>
                    <div style="background: #d4edda; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
                        {{ question.correct_answer }}
                    </div>
                </div>
                {% endif %}
            </div>
            {% elif question.question_type == 'reading' %}
            <div style="margin-top: 1rem;">
                {% if question.media_url %}
                <div style="margin-bottom: 1rem;">
                    <p style="color: #667eea; font-weight: bold;">üìñ ƒêo·∫°n vƒÉn</p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
                        {{ question.media_url }}
                    </div>
                </div>
                {% endif %}
                <strong>C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</strong>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
                    {{ student_answer }}
                </div>
                {% if question.correct_answer %}
                <div style="margin-top: 1rem;">
                    <strong>G·ª£i √Ω ƒë√°p √°n:</strong>
                    <div style="background: #d4edda; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
                        {{ question.correct_answer }}
                    </div>
                </div>
                {% endif %}
            </div>
            {% elif question.question_type == 'writing' %}
            <div style="margin-top: 1rem;">
                {% if question.support_content %}
                <div style="margin-bottom: 1rem;">
                    <p style="color: #667eea; font-weight: bold;">üìù H∆∞·ªõng d·∫´n</p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
                        {{ question.support_content }}
                    </div>
                </div>
                {% endif %}
                <strong>B√†i vi·∫øt c·ªßa b·∫°n:</strong>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
                    {{ student_answer }}
                </div>
                {% if question.correct_answer %}
                <div style="margin-top: 1rem;">
                    <strong>G·ª£i √Ω ƒë√°p √°n:</strong>
                    <div style="background: #d4edda; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
                        {{ question.correct_answer }}
                    </div>
                </div>
                {% endif %}
            </div>
            {% elif question.question_type == 'group' %}
            <div style="margin-top: 1rem;">
                {% if question.group_prompt %}
                <div style="background: #f0f4ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #667eea; font-weight: bold; margin-bottom: 0.5rem;">üìö Nh√≥m c√¢u h·ªèi</p>
                    <p style="margin: 0;">{{ question.group_prompt }}</p>
                </div>
                {% endif %}
                {% if question.media_url %}
                <div style="margin-bottom: 1rem;">
                    <p style="color: #667eea; font-weight: bold;">üéµ Media cho nh√≥m c√¢u h·ªèi</p>
                    {% if question.media_url.lower().endswith(('.mp3', '.wav', '.m4a', '.flac', '.ogg')) %}
                    <audio controls style="width: 100%;">
                        <source src="{{ question.media_url }}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                    {% else %}
                    <video controls style="width: 100%; max-height: 400px;">
                        <source src="{{ question.media_url }}" type="video/mp4">
                        Your browser does not support the video element.
                    </video>
                    {% endif %}
                </div>
                {% endif %}
                <strong>C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</strong>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
                    {{ student_answer }}
                </div>
                {% if question.correct_answer %}
                <div style="margin-top: 1rem;">
                    <strong>G·ª£i √Ω ƒë√°p √°n:</strong>
                    <div style="background: #d4edda; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
                        {{ question.correct_answer }}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% else %}
        <div style="padding: 2rem; text-align: center; color: #999;">
            <p>üì≠ ƒê·ªÅ thi n√†y kh√¥ng c√≥ c√¢u h·ªèi</p>
        </div>
        {% endif %}
    </div>
    
    <div class="text-center mt-3">
        <a href="{{ url_for('main.student_dashboard') }}" class="btn btn-primary">‚¨ÖÔ∏è V·ªÅ Dashboard</a>
        <a href="{{ url_for('exam.list_exams') }}" class="btn btn-secondary">üìù Xem ƒë·ªÅ thi kh√°c</a>
    </div>
</div>
{% endblock %}
