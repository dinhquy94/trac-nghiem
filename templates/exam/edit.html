{% extends "base.html" %}

{% block title %}Ch·ªânh s·ª≠a ƒë·ªÅ thi - {{ exam.title }}{% endblock %}

{% block extra_css %}
<style>
.question-item {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    border-left: 4px solid #667eea;
}
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    overflow-y: auto;
}
.modal-content {
    background: white;
    max-width: 800px;
    margin: 2rem auto;
    padding: 2rem;
    border-radius: 12px;
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}
.close {
    font-size: 2rem;
    cursor: pointer;
    color: #999;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-between align-center mb-3">
    <h1 style="color: white;">‚úèÔ∏è Ch·ªânh s·ª≠a ƒë·ªÅ thi</h1>
    <div class="d-flex gap-2">
        <a href="{{ url_for('exam.view_exam', exam_id=exam._id) }}" class="btn btn-secondary">‚¨ÖÔ∏è Quay l·∫°i</a>
    </div>
</div>

<div class="grid grid-2">
    <div class="card">
        <h3 class="card-header">üìã Th√¥ng tin ƒë·ªÅ thi</h3>
        <form method="POST">
            <div class="form-group">
                <label class="form-label">Ti√™u ƒë·ªÅ</label>
                <input type="text" name="title" class="form-control" value="{{ exam.title }}" required>
            </div>
            <div class="form-group">
                <label class="form-label">M√¥ t·∫£</label>
                <textarea name="description" class="form-control" rows="3">{{ exam.description }}</textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Lo·∫°i ƒë·ªÅ thi</label>
                <select name="exam_type" class="form-control" required>
                    <option value="test" {% if exam.exam_type == 'test' %}selected{% endif %}>Ki·ªÉm tra (c√≥ gi·ªõi h·∫°n th·ªùi gian)</option>
                    <option value="practice" {% if exam.exam_type == 'practice' %}selected{% endif %}>√în t·∫≠p (kh√¥ng gi·ªõi h·∫°n, c√≥ gi·∫£i th√≠ch)</option>
                </select>
            </div>
            <div class="grid grid-2">
                <div class="form-group">
                    <label class="form-label">Th·ªùi gian (ph√∫t)</label>
                    <input type="number" name="duration" class="form-control" value="{{ exam.duration }}" min="0">
                    <small style="color: #666;">ƒê·ªÉ 0 n·∫øu kh√¥ng gi·ªõi h·∫°n th·ªùi gian</small>
                </div>
                <div class="form-group">
                    <label class="form-label">ƒêi·ªÉm ƒë·∫°t (%)</label>
                    <input type="number" name="passing_score" class="form-control" value="{{ exam.passing_score }}" min="0" max="100" required>
                </div>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" name="is_public" {% if exam.is_public %}checked{% endif %}>
                    <span>C√¥ng khai ƒë·ªÅ thi</span>
                </label>
            </div>
            <button type="submit" class="btn btn-primary">C·∫≠p nh·∫≠t th√¥ng tin</button>
        </form>
    </div>
    
    <div class="card">
        <h3 class="card-header">ü§ñ T·∫°o c√¢u h·ªèi b·∫±ng AI</h3>
        <form method="POST" action="{{ url_for('exam.generate_questions', exam_id=exam._id) }}">
            <div class="form-group">
                <label class="form-label">Ch·ªçn t√†i li·ªáu</label>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px; padding: 0.5rem;">
                    {% for doc in documents %}
                    <label style="display: block; padding: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="document_ids" value="{{ doc._id }}">
                        {{ doc.title }}
                    </label>
                    {% endfor %}
                </div>
            </div>
            <div class="grid grid-3">
                <div class="form-group">
                    <label class="form-label">D·ªÖ</label>
                    <input type="number" name="num_easy" class="form-control" value="3" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Trung b√¨nh</label>
                    <input type="number" name="num_medium" class="form-control" value="5" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Kh√≥</label>
                    <input type="number" name="num_hard" class="form-control" value="2" min="0">
                </div>
            </div>
            <button type="submit" class="btn btn-success" style="width: 100%;">ü§ñ T·∫°o c√¢u h·ªèi AI</button>
        </form>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header d-flex justify-between align-center">
        <span>‚ùì C√¢u h·ªèi ({{ questions|length }})</span>
        <button onclick="openModal('addModal')" class="btn btn-success btn-sm">‚ûï Th√™m c√¢u h·ªèi</button>
    </div>
    
    {% if questions %}
        {% for q in questions %}
        <div class="question-item">
            <div class="d-flex justify-between align-center mb-2">
                <strong>C√¢u {{ loop.index }}: {{ q.question_text }}</strong>
                <div class="d-flex gap-1">
                    <span class="badge badge-{{ 'success' if q.difficulty == 'easy' else ('warning' if q.difficulty == 'medium' else 'danger') }}">
                        {{ q.difficulty }}
                    </span>
                    <span class="badge badge-info">{{ q.question_type }}</span>
                </div>
            </div>
            
            {% if q.question_type == 'multiple_choice' %}
            <div style="margin-left: 1rem;">
                {% for opt in q.options %}
                <div style="color: {{ '#28a745' if opt.startswith(q.correct_answer) else '#666' }};">
                    {{ opt }} {% if opt.startswith(q.correct_answer) %}‚úì{% endif %}
                </div>
                {% endfor %}
            </div>
            {% elif q.question_type == 'true_false' %}
            <div style="margin-left: 1rem; color: #28a745;">
                ƒê√°p √°n: {{ q.correct_answer }}
            </div>
            {% elif q.question_type in ['listening', 'speaking', 'reading', 'writing'] %}
            <div style="margin-left: 1rem;">
                {% if q.media_url %}
                <div style="color: #667eea; margin-bottom: 0.5rem;">
                    üéµ Media: <a href="{{ q.media_url }}" target="_blank">{{ q.media_url[:50] }}...</a>
                </div>
                {% endif %}
                {% if q.support_content %}
                <div style="color: #666; margin-bottom: 0.5rem;">
                    üìÑ H·ªó tr·ª£: {{ q.support_content[:100] }}...
                </div>
                {% endif %}
                <div style="color: #28a745;">
                    ‚úì ƒê√°p √°n mong ƒë·ª£i: {{ q.correct_answer[:100] }}...
                </div>
            </div>
            {% elif q.question_type == 'group' %}
            <div style="margin-left: 1rem; color: #667eea;">
                üìö Nh√≥m c√¢u h·ªèi
                {% if q.group_prompt %}
                <div style="margin-top: 0.5rem; color: #666;">
                    ƒê·ªÅ b√†i: {{ q.group_prompt[:100] }}...
                </div>
                {% endif %}
                {% if q.media_url %}
                <div style="margin-top: 0.5rem; color: #667eea;">
                    üéµ Media: <a href="{{ q.media_url }}" target="_blank">{{ q.media_url[:50] }}...</a>
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            {% if q.explanation %}
            <div class="alert alert-info mt-2" style="background: #e7f3ff; border-left: 3px solid #2196f3; padding: 0.75rem;">
                <strong>üí° Gi·∫£i th√≠ch:</strong> {{ q.explanation }}
            </div>
            {% endif %}
            
            <div class="d-flex gap-1 mt-2">
                <button type="button" class="btn btn-sm btn-primary" onclick='editQuestion({{ q._id|string|tojson }}, {{ q.question_text|tojson }}, "{{ q.question_type }}", {{ q.options|tojson if q.question_type == "multiple_choice" else "[]" }}, "{{ q.correct_answer }}", "{{ q.difficulty }}", {{ q.points }}, {{ q.explanation|tojson if q.explanation else '""' }})'>S·ª≠a</button>
                <form method="POST" action="{{ url_for('exam.delete_question', exam_id=exam._id, question_id=q._id) }}" style="display: inline;" onsubmit="return confirm('X√≥a c√¢u h·ªèi n√†y?');">
                    <button type="submit" class="btn btn-sm btn-danger">X√≥a</button>
                </form>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <p style="color: #666; text-align: center; padding: 2rem;">Ch∆∞a c√≥ c√¢u h·ªèi n√†o</p>
    {% endif %}
</div>

<!-- Add Question Modal -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚ûï Th√™m c√¢u h·ªèi</h3>
            <span class="close" onclick="closeModal('addModal')">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('exam.add_question', exam_id=exam._id) }}" enctype="multipart/form-data">
            <div class="form-group">
                <label class="form-label">C√¢u h·ªèi</label>
                <textarea name="question_text" class="form-control" rows="3" required></textarea>
            </div>
            
            <div class="grid grid-3">
                <div class="form-group">
                    <label class="form-label">Lo·∫°i c√¢u h·ªèi</label>
                    <select name="question_type" id="questionType" class="form-control" required>
                        <option value="multiple_choice">Tr·∫Øc nghi·ªám</option>
                        <option value="true_false">ƒê√∫ng/Sai</option>
                        <option value="essay">T·ª± lu·∫≠n</option>
                        <optgroup label="Ti·∫øng Anh">
                            <option value="listening">Nghe</option>
                            <option value="speaking">N√≥i</option>
                            <option value="reading">ƒê·ªçc</option>
                            <option value="writing">Vi·∫øt</option>
                            <option value="group">Nh√≥m c√¢u h·ªèi</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ƒê·ªô kh√≥</label>
                    <select name="difficulty" class="form-control" required>
                        <option value="easy">D·ªÖ</option>
                        <option value="medium">Trung b√¨nh</option>
                        <option value="hard">Kh√≥</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ƒêi·ªÉm</label>
                    <input type="number" name="points" class="form-control" value="1" min="1" required>
                </div>
            </div>
            
            <div id="multipleChoice">
                <div class="form-group">
                    <label class="form-label">ƒê√°p √°n A</label>
                    <input type="text" name="option_a" class="form-control" placeholder="A. ...">
                </div>
                <div class="form-group">
                    <label class="form-label">ƒê√°p √°n B</label>
                    <input type="text" name="option_b" class="form-control" placeholder="B. ...">
                </div>
                <div class="form-group">
                    <label class="form-label">ƒê√°p √°n C</label>
                    <input type="text" name="option_c" class="form-control" placeholder="C. ...">
                </div>
                <div class="form-group">
                    <label class="form-label">ƒê√°p √°n D</label>
                    <input type="text" name="option_d" class="form-control" placeholder="D. ...">
                </div>
                <div class="form-group">
                    <label class="form-label">ƒê√°p √°n ƒë√∫ng</label>
                    <select name="correct_answer" class="form-control" required>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </div>
            </div>
            
            <div id="trueFalse" style="display: none;">
                <div class="form-group">
                    <label class="form-label">ƒê√°p √°n ƒë√∫ng</label>
                    <select name="correct_answer" class="form-control">
                        <option value="ƒê√∫ng">ƒê√∫ng</option>
                        <option value="Sai">Sai</option>
                    </select>
                </div>
            </div>
            
            <!-- Listening, Speaking, Reading, Writing -->
            <div id="skillQuestion" style="display: none;">
                <div class="form-group">
                    <label class="form-label">üìÅ T·∫£i l√™n Media (Audio/Video)</label>
                    <input type="file" name="media_file" class="form-control" accept="audio/*,video/*">
                    <small style="color: #666; display: block; margin-top: 0.3rem;">ƒê·ªãnh d·∫°ng h·ªó tr·ª£: MP3, WAV, M4A, MP4, WebM, AVI, MOV (Max 50MB)</small>
                </div>
                <div class="form-group" style="text-align: center; color: #999; padding: 1rem 0;">
                    <strong>HO·∫∂C</strong>
                </div>
                <div class="form-group">
                    <label class="form-label">Media URL (Link tr·ª±c ti·∫øp)</label>
                    <input type="url" name="media_url" class="form-control" placeholder="https://example.com/audio.mp3">
                </div>
                <div class="form-group">
                    <label class="form-label">N·ªôi dung h·ªó tr·ª£ (n·∫øu c√≥)</label>
                    <textarea name="support_content" class="form-control" rows="3" placeholder="VƒÉn b·∫£n, h√¨nh ·∫£nh ho·∫∑c h∆∞·ªõng d·∫´n..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ƒê√°p √°n mong ƒë·ª£i</label>
                    <textarea name="correct_answer" class="form-control" rows="3" placeholder="M√¥ t·∫£ ƒë√°p √°n ƒë√∫ng..." required></textarea>
                </div>
            </div>
            
            <!-- Nh√≥m c√¢u h·ªèi -->
            <div id="groupQuestion" style="display: none;">
                <div class="form-group">
                    <label class="form-label">ƒê·ªÅ b√†i chung (ƒë·ªÉ tr·ªëng ƒë·ªÉ s·ª≠ d·ª•ng c√¢u h·ªèi l√†m ƒë·ªÅ)</label>
                    <textarea name="group_prompt" class="form-control" rows="3" placeholder="ƒêo·∫°n vƒÉn/b√†i t·∫≠p chung cho c·∫£ nh√≥m..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">üìÅ Media cho nh√≥m c√¢u h·ªèi (Audio/Video, kh√¥ng b·∫Øt bu·ªôc)</label>
                    <input type="file" name="media_file" class="form-control" accept="audio/*,video/*">
                    <small style="color: #666; display: block; margin-top: 0.3rem;">ƒê·ªãnh d·∫°ng h·ªó tr·ª£: MP3, WAV, M4A, MP4, WebM, AVI, MOV (Max 50MB)</small>
                </div>
                <div class="form-group" style="text-align: center; color: #999; padding: 0.5rem 0;">
                    <strong>HO·∫∂C</strong>
                </div>
                <div class="form-group">
                    <label class="form-label">Media URL (Link tr·ª±c ti·∫øp)</label>
                    <input type="url" name="media_url" class="form-control" placeholder="https://example.com/audio.mp3">
                </div>
                <div class="form-group">
                    <label class="form-label">Ghi ch√∫: ƒê·ªÉ th√™m c√¢u h·ªèi con, h√£y c·∫≠p nh·∫≠t c√¢u h·ªèi n√†y sau khi t·∫°o</label>
                    <small style="color: #666; display: block; margin-top: 0.5rem;">
                        Lo·∫°i c√¢u h·ªèi nh√≥m cho ph√©p t·∫°o nhi·ªÅu c√¢u h·ªèi li√™n quan ƒë·∫øn m·ªôt ƒë·ªÅ b√†i chung.
                    </small>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Th√™m c√¢u h·ªèi</button>
        </form>
    </div>
</div>

<!-- Edit Question Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚úèÔ∏è S·ª≠a c√¢u h·ªèi</h3>
            <span class="close" onclick="closeModal('editModal')">&times;</span>
        </div>
        <form method="POST" id="editQuestionForm" action="" enctype="multipart/form-data">
            <input type="hidden" id="editQuestionId" name="question_id">
            
            <div class="form-group">
                <label class="form-label">N·ªôi dung c√¢u h·ªèi</label>
                <textarea id="editQuestionText" name="question_text" class="form-control" rows="3" required></textarea>
            </div>
            
            <div class="grid grid-2">
                <div class="form-group">
                    <label class="form-label">Lo·∫°i c√¢u h·ªèi</label>
                    <select id="editQuestionType" name="question_type" class="form-control" required>
                        <option value="multiple_choice">Tr·∫Øc nghi·ªám</option>
                        <option value="true_false">ƒê√∫ng/Sai</option>
                        <option value="essay">T·ª± lu·∫≠n</option>
                        <optgroup label="Ti·∫øng Anh">
                            <option value="listening">Nghe</option>
                            <option value="speaking">N√≥i</option>
                            <option value="reading">ƒê·ªçc</option>
                            <option value="writing">Vi·∫øt</option>
                            <option value="group">Nh√≥m c√¢u h·ªèi</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ƒê·ªô kh√≥</label>
                    <select id="editDifficulty" name="difficulty" class="form-control" required>
                        <option value="easy">D·ªÖ</option>
                        <option value="medium">Trung b√¨nh</option>
                        <option value="hard">Kh√≥</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ƒêi·ªÉm</label>
                    <input type="number" id="editPoints" name="points" class="form-control" value="1" min="1" required>
                </div>
            </div>
            
            <div id="multipleChoiceEdit">
                <div class="form-group">
                    <label class="form-label">ƒê√°p √°n A</label>
                    <input type="text" id="editOptionA" name="option_a" class="form-control" placeholder="A. ...">
                </div>
                <div class="form-group">
                    <label class="form-label">ƒê√°p √°n B</label>
                    <input type="text" id="editOptionB" name="option_b" class="form-control" placeholder="B. ...">
                </div>
                <div class="form-group">
                    <label class="form-label">ƒê√°p √°n C</label>
                    <input type="text" id="editOptionC" name="option_c" class="form-control" placeholder="C. ...">
                </div>
                <div class="form-group">
                    <label class="form-label">ƒê√°p √°n D</label>
                    <input type="text" id="editOptionD" name="option_d" class="form-control" placeholder="D. ...">
                </div>
                <div class="form-group">
                    <label class="form-label">ƒê√°p √°n ƒë√∫ng</label>
                    <select id="editCorrectAnswerMC" name="correct_answer" class="form-control" required>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </div>
            </div>
            
            <div id="trueFalseEdit" style="display: none;">
                <div class="form-group">
                    <label class="form-label">ƒê√°p √°n ƒë√∫ng</label>
                    <select id="editCorrectAnswerTF" name="correct_answer" class="form-control">
                        <option value="ƒê√∫ng">ƒê√∫ng</option>
                        <option value="Sai">Sai</option>
                    </select>
                </div>
            </div>
            
            <!-- Listening, Speaking, Reading, Writing -->
            <div id="skillQuestionEdit" style="display: none;">
                <div class="form-group">
                    <label class="form-label">üìÅ T·∫£i l√™n Media m·ªõi (Audio/Video)</label>
                    <input type="file" id="editMediaFile" name="media_file" class="form-control" accept="audio/*,video/*">
                    <small style="color: #666; display: block; margin-top: 0.3rem;">ƒê·ªãnh d·∫°ng h·ªó tr·ª£: MP3, WAV, M4A, MP4, WebM, AVI, MOV (Max 50MB)</small>
                </div>
                <div class="form-group" style="text-align: center; color: #999; padding: 0.5rem 0;">
                    <strong>HO·∫∂C</strong>
                </div>
                <div class="form-group">
                    <label class="form-label">Media URL (Link tr·ª±c ti·∫øp)</label>
                    <input type="url" id="editMediaUrl" name="media_url" class="form-control" placeholder="https://example.com/audio.mp3">
                </div>
                <div class="form-group">
                    <label class="form-label">N·ªôi dung h·ªó tr·ª£ (n·∫øu c√≥)</label>
                    <textarea id="editSupportContent" name="support_content" class="form-control" rows="3" placeholder="VƒÉn b·∫£n, h√¨nh ·∫£nh ho·∫∑c h∆∞·ªõng d·∫´n..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ƒê√°p √°n mong ƒë·ª£i</label>
                    <textarea id="editSkillCorrectAnswer" name="correct_answer" class="form-control" rows="3" placeholder="M√¥ t·∫£ ƒë√°p √°n ƒë√∫ng..." required></textarea>
                </div>
            </div>
            
            <!-- Nh√≥m c√¢u h·ªèi -->
            <div id="groupQuestionEdit" style="display: none;">
                <div class="form-group">
                    <label class="form-label">ƒê·ªÅ b√†i chung (ƒë·ªÉ tr·ªëng ƒë·ªÉ s·ª≠ d·ª•ng c√¢u h·ªèi l√†m ƒë·ªÅ)</label>
                    <textarea id="editGroupPrompt" name="group_prompt" class="form-control" rows="3" placeholder="ƒêo·∫°n vƒÉn/b√†i t·∫≠p chung cho c·∫£ nh√≥m..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">üìÅ Media cho nh√≥m c√¢u h·ªèi (Audio/Video, kh√¥ng b·∫Øt bu·ªôc)</label>
                    <input type="file" id="editGroupMediaFile" name="media_file" class="form-control" accept="audio/*,video/*">
                    <small style="color: #666; display: block; margin-top: 0.3rem;">ƒê·ªãnh d·∫°ng h·ªó tr·ª£: MP3, WAV, M4A, MP4, WebM, AVI, MOV (Max 50MB)</small>
                </div>
                <div class="form-group" style="text-align: center; color: #999; padding: 0.5rem 0;">
                    <strong>HO·∫∂C</strong>
                </div>
                <div class="form-group">
                    <label class="form-label">Media URL (Link tr·ª±c ti·∫øp)</label>
                    <input type="url" id="editGroupMediaUrl" name="media_url" class="form-control" placeholder="https://example.com/audio.mp3">
                </div>
                <div class="form-group">
                    <label class="form-label">Ghi ch√∫: ƒê·ªÉ th√™m c√¢u h·ªèi con, h√£y c·∫≠p nh·∫≠t c√¢u h·ªèi n√†y sau khi t·∫°o</label>
                    <small style="color: #666; display: block; margin-top: 0.5rem;">
                        Lo·∫°i c√¢u h·ªèi nh√≥m cho ph√©p t·∫°o nhi·ªÅu c√¢u h·ªèi li√™n quan ƒë·∫øn m·ªôt ƒë·ªÅ b√†i chung.
                    </small>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Gi·∫£i th√≠ch (d√†nh cho ƒë·ªÅ √¥n t·∫≠p)</label>
                <textarea id="editExplanation" name="explanation" class="form-control" rows="3" placeholder="Gi·∫£i th√≠ch t·∫°i sao ƒë√°p √°n n√†y ƒë√∫ng, gi√∫p h·ªçc sinh hi·ªÉu r√µ h∆°n..."></textarea>
                <button type="button" id="generateExplanationBtn" class="btn btn-sm btn-success mt-1" onclick="generateExplanation()">
                    ü§ñ T·∫°o gi·∫£i th√≠ch AI
                </button>
            </div>
            
            <button type="submit" class="btn btn-primary">C·∫≠p nh·∫≠t c√¢u h·ªèi</button>
        </form>
    </div>
</div>

<script>
function openModal(id) {
    document.getElementById(id).style.display = 'block';
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

document.getElementById('questionType').addEventListener('change', function() {
    const mc = document.getElementById('multipleChoice');
    const tf = document.getElementById('trueFalse');
    const skill = document.getElementById('skillQuestion');
    const group = document.getElementById('groupQuestion');
    
    // ·∫®n t·∫•t c·∫£
    mc.style.display = 'none';
    tf.style.display = 'none';
    skill.style.display = 'none';
    group.style.display = 'none';
    
    // Hi·ªÉn th·ªã theo lo·∫°i c√¢u h·ªèi
    if (this.value === 'multiple_choice') {
        mc.style.display = 'block';
    } else if (this.value === 'true_false') {
        tf.style.display = 'block';
    } else if (['listening', 'speaking', 'reading', 'writing'].includes(this.value)) {
        skill.style.display = 'block';
    } else if (this.value === 'group') {
        group.style.display = 'block';
    }
});

// Close modal when clicking outside
// Close modal when clicking outside
window.onclick = function(event) {
    if (event.target.className === 'modal') {
        event.target.style.display = 'none';
    }
}

// Edit question function - Note: Need to fetch full question data from server for new types
function editQuestion(id, text, type, options, correctAnswer, difficulty, points, explanation) {
    document.getElementById('editQuestionId').value = id;
    document.getElementById('editQuestionText').value = text;
    document.getElementById('editQuestionType').value = type;
    document.getElementById('editDifficulty').value = difficulty;
    document.getElementById('editPoints').value = points;
    document.getElementById('editExplanation').value = explanation || '';
    
    // Set form action URL
    const form = document.getElementById('editQuestionForm');
    form.action = `{{ url_for('exam.edit_question', exam_id=exam._id, question_id='PLACEHOLDER') }}`.replace('PLACEHOLDER', id);
    
    const mcEdit = document.getElementById('multipleChoiceEdit');
    const tfEdit = document.getElementById('trueFalseEdit');
    const skillEdit = document.getElementById('skillQuestionEdit');
    const groupEdit = document.getElementById('groupQuestionEdit');
    
    // Hide all sections
    mcEdit.style.display = 'none';
    tfEdit.style.display = 'none';
    skillEdit.style.display = 'none';
    groupEdit.style.display = 'none';
    
    if (type === 'multiple_choice') {
        mcEdit.style.display = 'block';
        
        // Parse options if they're strings like "A. Answer text"
        const optionMap = {};
        options.forEach(opt => {
            const match = opt.match(/^([A-D])\.\s*(.+)$/);
            if (match) {
                optionMap[match[1]] = match[2];
            }
        });
        
        document.getElementById('editOptionA').value = optionMap['A'] || '';
        document.getElementById('editOptionB').value = optionMap['B'] || '';
        document.getElementById('editOptionC').value = optionMap['C'] || '';
        document.getElementById('editOptionD').value = optionMap['D'] || '';
        document.getElementById('editCorrectAnswerMC').value = correctAnswer;
    } else if (type === 'true_false') {
        tfEdit.style.display = 'block';
        document.getElementById('editCorrectAnswerTF').value = correctAnswer;
    } else if (['listening', 'speaking', 'reading', 'writing'].includes(type)) {
        skillEdit.style.display = 'block';
        document.getElementById('editSkillCorrectAnswer').value = correctAnswer;
        // Note: media_url and support_content need to be fetched from server
    } else if (type === 'group') {
        groupEdit.style.display = 'block';
        // Note: group_prompt needs to be fetched from server
    }
    
    openModal('editModal');
}

// Generate explanation for current question
function generateExplanation() {
    const questionText = document.getElementById('editQuestionText').value;
    const questionType = document.getElementById('editQuestionType').value;
    let correctAnswer = '';
    
    if (questionType === 'multiple_choice') {
        const letter = document.getElementById('editCorrectAnswerMC').value;
        const optionField = document.getElementById('editOption' + letter);
        correctAnswer = optionField ? optionField.value : '';
    } else if (questionType === 'true_false') {
        correctAnswer = document.getElementById('editCorrectAnswerTF').value;
    }
    
    if (!questionText || !correctAnswer) {
        alert('Vui l√≤ng nh·∫≠p c√¢u h·ªèi v√† ƒë√°p √°n tr∆∞·ªõc khi t·∫°o gi·∫£i th√≠ch');
        return;
    }
    
    const btn = document.getElementById('generateExplanationBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ ƒêang t·∫°o...';
    
    const questionId = document.getElementById('editQuestionId').value;
    
    fetch(`{{ url_for('exam.generate_question_explanation', exam_id=exam._id, question_id='PLACEHOLDER') }}`.replace('PLACEHOLDER', questionId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            question_text: questionText,
            correct_answer: correctAnswer
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('editExplanation').value = data.explanation;
        } else {
            alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ t·∫°o gi·∫£i th√≠ch'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('L·ªói khi t·∫°o gi·∫£i th√≠ch');
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = 'ü§ñ T·∫°o gi·∫£i th√≠ch AI';
    });
}

// Handle question type change in edit modal
document.addEventListener('DOMContentLoaded', function() {
    const editTypeSelect = document.getElementById('editQuestionType');
    if (editTypeSelect) {
        editTypeSelect.addEventListener('change', function() {
            const mcEdit = document.getElementById('multipleChoiceEdit');
            const tfEdit = document.getElementById('trueFalseEdit');
            const skillEdit = document.getElementById('skillQuestionEdit');
            const groupEdit = document.getElementById('groupQuestionEdit');
            
            // Hide all
            mcEdit.style.display = 'none';
            tfEdit.style.display = 'none';
            skillEdit.style.display = 'none';
            groupEdit.style.display = 'none';
            
            // Show based on type
            if (this.value === 'multiple_choice') {
                mcEdit.style.display = 'block';
            } else if (this.value === 'true_false') {
                tfEdit.style.display = 'block';
            } else if (['listening', 'speaking', 'reading', 'writing'].includes(this.value)) {
                skillEdit.style.display = 'block';
            } else if (this.value === 'group') {
                groupEdit.style.display = 'block';
            }
        });
    }
});
</script>
{% endblock %}
